name: Download Artifact from repo-a

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

jobs:
  download:
    runs-on: [self-hosted, linux]
    
    steps:
      - name: Check environment
        run: |
          echo "Runner working directory: $(pwd)"
          echo "User: $(whoami)"
          ls -la
      
      - name: Fetch artifact list
        id: fetch
        run: |
          # æ·»åŠ é”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯
          echo "Fetching artifacts from liushiyou006/aliyun_docker_sync"
          
          curl -s \
            -H "Authorization: Bearer ${{ secrets.LIUDONGDONG7397 }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/liushiyou006/aliyun_docker_sync/actions/artifacts?per_page=10" \
            > artifacts.json
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–
          if [ ! -s artifacts.json ]; then
            echo "âŒ Failed to fetch artifacts or response is empty"
            exit 1
          fi
          
          # æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
          TOTAL_COUNT=$(jq '.total_count' artifacts.json)
          echo "Total artifacts found: $TOTAL_COUNT"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ artifacts
          if [ "$TOTAL_COUNT" -eq "0" ]; then
            echo "âš ï¸ No artifacts found"
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
            exit 0  # æ­£å¸¸é€€å‡ºï¼Œåªæ˜¯æ²¡æœ‰ artifacts
          else
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºå‰å‡ ä¸ª artifacts ä¿¡æ¯
            echo "Latest artifacts:"
            jq -r '.artifacts[:3][] | "  â€¢ \(.name) (ID: \(.id), Created: \(.created_at))"' artifacts.json
            
            # è·å–æœ€æ–°çš„ artifact ä¿¡æ¯
            LATEST_ID=$(jq '.artifacts[0].id' artifacts.json)
            LATEST_NAME=$(jq -r '.artifacts[0].name' artifacts.json)
            
            echo "artifact_id=$LATEST_ID" >> $GITHUB_OUTPUT
            echo "artifact_name=$LATEST_NAME" >> $GITHUB_OUTPUT
          fi
      
      - name: Download artifact
        if: steps.fetch.outputs.has_artifacts == 'true'
        id: download
        run: |
          # åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆç¡®ä¿æœ‰æƒé™ï¼‰
          TARGET_DIR="/home/asus/actions-runner/data/from-repo-a"
          mkdir -p "$TARGET_DIR"
          
          # è·å–æœ€æ–°çš„ artifact ID
          ARTIFACT_ID=$(jq '.artifacts[0].id' artifacts.json)
          ARTIFACT_NAME=$(jq -r '.artifacts[0].name' artifacts.json)
          
          echo "Downloading artifact: $ARTIFACT_NAME (ID: $ARTIFACT_ID)"
          echo "Target directory: $TARGET_DIR"
          
          # ä¸‹è½½ artifact
          curl -L \
            -H "Authorization: Bearer ${{ secrets.LIUDONGDONG7397 }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/liushiyou006/aliyun_docker_sync/actions/artifacts/$ARTIFACT_ID/zip" \
            -o "$TARGET_DIR/artifact.zip"
          
          # æ£€æŸ¥ä¸‹è½½æ˜¯å¦æˆåŠŸ
          if [ -f "$TARGET_DIR/artifact.zip" ]; then
            FILE_SIZE=$(wc -c < "$TARGET_DIR/artifact.zip")
            echo "âœ… Download successful: $FILE_SIZE bytes"
            echo "download_path=$TARGET_DIR/artifact.zip" >> $GITHUB_OUTPUT
          else
            echo "âŒ Download failed"
            exit 1
          fi
      
      - name: Unzip and process
        if: steps.fetch.outputs.has_artifacts == 'true'
        run: |
          TARGET_DIR="/home/asus/actions-runner/data/from-repo-a"
          
          echo "Unzipping $TARGET_DIR/artifact.zip..."
          
          # å…ˆæ£€æŸ¥æ–‡ä»¶
          if [ ! -f "$TARGET_DIR/artifact.zip" ]; then
            echo "âŒ Artifact file not found"
            exit 1
          fi
          
          # åˆ›å»ºè§£å‹ç›®å½•
          EXTRACT_DIR="$TARGET_DIR/extracted"
          mkdir -p "$EXTRACT_DIR"
          
          # è§£å‹æ–‡ä»¶
          unzip -o "$TARGET_DIR/artifact.zip" -d "$EXTRACT_DIR"
          
          echo "âœ… Extraction complete"
          echo "Extracted files in $EXTRACT_DIR:"
          ls -la "$EXTRACT_DIR"
          
          # å¦‚æœæœ‰æ–‡ä»¶ï¼Œåˆ—å‡ºè¯¦ç»†å†…å®¹
          if [ -d "$EXTRACT_DIR" ]; then
            echo "Contents:"
            find "$EXTRACT_DIR" -type f | while read file; do
              echo "  ğŸ“„ $file ($(wc -c < "$file") bytes)"
            done
          fi
      
      - name: Cleanup (optional)
        if: always()
        run: |
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f artifacts.json
          echo "Cleanup completed"
